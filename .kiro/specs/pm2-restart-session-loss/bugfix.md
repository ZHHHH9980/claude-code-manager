# Bug 修复需求文档

## 简介

本次 bugfix 解决 PM2 重启导致的两个核心问题：

1. **前端页面不可用**：前后端在同一进程，后端重启导致前端静态文件服务中断
2. **Agent 会话丢失**：agentChatSessionId 未持久化，重启后无法继续对话

关于"所有任务变 interrupted"：代码已有正确的错误隔离（每个任务独立 try-catch），此问题可能是用户环境导致（worktree 被删除等），建议先添加详细日志诊断，而非修改核心逻辑。

## Bug 分析

### 根本原因

**问题 1: 前后端耦合导致页面不可用**

当前架构：Express 服务器同时提供 API 和静态文件（`app.use(express.static(...))`）

- PM2 重启时，整个 Node.js 进程重启
- HTTP 服务器停止，静态文件服务中断
- 用户刷新页面会失败（无法加载 HTML/JS/CSS）
- Socket.io 连接断开，虽然会自动重连，但用户体验极差

**问题 2: Agent 会话 ID 未持久化**

当前实现：`let agentChatSessionId = null;` （内存变量）

- PM2 重启后，内存变量丢失
- 用户的 agent chat 历史在数据库中，但会话 ID 丢失
- 无法继续之前的对话，必须清除历史重新开始

### 当前行为（缺陷）

1.1 当执行 `pm2 restart` 时，前端静态文件服务中断，用户刷新页面会失败

1.2 当服务器重启时，socket.io 连接断开，Terminal 组件虽然会自动重连，但体验差

1.3 当服务器重启时，内存中的 agentChatSessionId 丢失，agent chat 无法继续

### 期望行为（正确）

2.1 前端静态文件应该由独立的服务提供（如 nginx），不受后端重启影响

2.2 后端 API 服务重启时，前端页面保持可用，socket 自动重连后恢复功能

2.3 agentChatSessionId 应该持久化到数据库，重启后自动恢复

### 不变行为（回归预防）

3.1 当启动新任务时，系统应该继续在正确的工作目录创建新的 PTY 会话

3.2 当发送终端输入时，系统应该继续将其转发到正确的 PTY 会话

3.3 当接收到终端输出时，系统应该继续将其广播到所有连接的客户端

3.4 当停止任务时，系统应该继续正确终止 PTY 会话

3.5 当多个客户端连接到同一会话时，系统应该继续向所有客户端共享输出

3.6 当服务器首次启动时，系统应该继续在没有现有会话的情况下正确初始化

## 关于"所有任务 interrupted"的说明

**代码审查结果**：recoverSessions() 已经为每个任务使用独立的 try-catch，错误隔离是正确的。

**可能原因**：
- 用户环境问题：所有任务的 worktree_path 都不存在（被删除或路径错误）
- ptyManager.ensureSession() 对所有任务都失败（需要查看具体错误）

**建议**：
- 添加详细的恢复日志（成功/失败统计、失败原因）
- 不修改核心恢复逻辑（已经是正确的）
- 让用户根据日志诊断环境问题

这不是本次 bugfix 的重点，可以作为独立的改进任务。
